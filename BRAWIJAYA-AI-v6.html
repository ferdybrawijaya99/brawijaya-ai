<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BRAWIJAYA-AI v6 — By : FERDY BRAWIJAYA</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root{--brand1:#7c3aed;--brand2:#a855f7;--bg:#0a0613;--panel:rgba(255,255,255,.05);--border:rgba(255,255,255,.08);--ink:#f3f1ff;}
    html,body{height:100%}
    body{background:radial-gradient(900px 400px at 10% 0, rgba(124,58,237,.12), transparent), var(--bg); color:var(--ink); font-family:Inter,ui-sans-serif,system-ui; margin:0}
    .card{background:var(--panel);border:1px solid var(--border);backdrop-filter:blur(6px);border-radius:12px}
    .btn{background:linear-gradient(90deg,var(--brand1),var(--brand2));}
    .pill{border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:6px 8px}
    .progress{height:8px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--brand1),var(--brand2));width:0%}
    .thumb{width:120px;height:68px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.06)}
    .task-row{display:flex;gap:12px;align-items:center}
    .muted{opacity:.8;font-size:12px}
    input[type="color"]{height:36px;width:44px;padding:2px;border-radius:8px;border:1px solid var(--border);background:transparent}
  </style>
</head>
<body>
  <header class="py-4 px-6 border-b border-white border-opacity-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg" id="logo" style="background:linear-gradient(45deg,var(--brand1),var(--brand2))"></div>
      <div>
        <div class="text-lg font-bold">BRAWIJAYA-AI v6</div>
        <div class="text-xs muted">By : FERDY BRAWIJAYA</div>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <span class="muted" data-i18n="theme">Tema</span>
        <input id="brand1" type="color" title="Brand 1"/>
        <input id="brand2" type="color" title="Brand 2"/>
      </div>
      <div class="flex items-center gap-2">
        <span class="muted" data-i18n="language">Bahasa</span>
        <button id="lang-id" class="pill bg-purple-700 text-xs">ID</button>
        <button id="lang-en" class="pill text-xs">EN</button>
      </div>
    </div>
  </header>

  <main class="p-6 max-w-6xl mx-auto grid lg:grid-cols-3 gap-6">
    <!-- Controls -->
    <section class="card p-4 lg:col-span-1 space-y-4">
      <h3 class="font-semibold" data-i18n="createVideo">Create Video</h3>
      <div>
        <label class="text-sm muted" data-i18n="promptLabel">Prompt</label>
        <textarea id="prompt" rows="4" class="w-full mt-2 p-2 rounded bg-black bg-opacity-30" placeholder="Deskripsikan animasi..."></textarea>
      </div>
      <div>
        <label class="text-sm muted" data-i18n="uploadLabel">Upload Image</label>
        <input id="file" type="file" accept="image/*" class="w-full mt-2 text-sm"/>
      </div>
      <div class="flex gap-2">
        <div>
          <label class="text-sm muted" data-i18n="arLabel">Aspect Ratio</label>
          <div class="mt-2 flex gap-2">
            <button class="ar-btn pill" data-ar="16:9">16:9</button>
            <button class="ar-btn pill" data-ar="1:1">1:1</button>
            <button class="ar-btn pill" data-ar="9:16">9:16</button>
          </div>
        </div>
        <div>
          <label class="text-sm muted" data-i18n="resLabel">Resolution</label>
          <div class="mt-2 flex gap-2">
            <button class="res-btn pill" data-res="360p">360p</button>
            <button class="res-btn pill" data-res="720p">720p</button>
            <button class="res-btn pill" data-res="1080p">1080p</button>
          </div>
        </div>
      </div>
      <div class="flex gap-2 mt-3">
        <button id="enqueue" class="btn text-white px-4 py-2 rounded">Generate (Queue)</button>
        <button id="clearHistory" class="pill">Clear History</button>
      </div>
      <p class="muted text-xs mt-2" data-i18n="privacyNote">Demo mode renders in browser. For cloud upload, configure upload hook.</p>
    </section>

    <!-- Canvas & Live Preview -->
    <section class="card p-4 lg:col-span-2 space-y-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold" data-i18n="livePreview">Live Preview</div>
        <div class="muted text-xs">Queue: <span id="queueCount">0</span></div>
      </div>
      <div class="aspect-video bg-black rounded overflow-hidden grid place-items-center relative">
        <video id="player" controls class="w-full h-full object-cover"></video>
        <div id="livePlaceholder" class="absolute text-center muted">Hasil akan muncul di sini</div>
      </div>

      <div class="mt-4">
        <h4 class="font-semibold">Task Queue</h4>
        <div id="queue" class="mt-2 space-y-3"></div>
      </div>

      <div class="mt-6">
        <h4 class="font-semibold">Recent Tasks</h4>
        <div id="tasks" class="mt-2 space-y-3"></div>
      </div>
    </section>
  </main>

  <canvas id="work" style="display:none"></canvas>

  <script>
    lucide.createIcons();

    // --- I18N ---
    const I18N = {
      id: { createVideo:"Create Video", promptLabel:"Prompt", uploadLabel:"Upload Gambar", arLabel:"Aspect Ratio", resLabel:"Resolution", btnGenerate:"Generate", privacyNote:"Catatan: Mode demo merender video sepenuhnya di browser.", livePreview:"Live Preview", theme:"Tema", language:"Bahasa", recentTasks:"Recent Tasks", download:"Download", copyLink:"Copy Link", share:"Bagikan", upload:"Upload" },
      en: { createVideo:"Create Video", promptLabel:"Prompt", uploadLabel:"Upload Image", arLabel:"Aspect Ratio", resLabel:"Resolution", btnGenerate:"Generate", privacyNote:"Note: Demo mode renders entirely in your browser.", livePreview:"Live Preview", theme:"Theme", language:"Language", recentTasks:"Recent Tasks", download:"Download", copyLink:"Copy Link", share:"Share", upload:"Upload" }
    };
    let currentLang = localStorage.getItem("brawijaya.lang") || "id";
    function applyLang(lang){
      currentLang = lang; localStorage.setItem("brawijaya.lang", lang);
      document.querySelectorAll("[data-i18n]").forEach(el=>{ const k=el.getAttribute("data-i18n"); if(I18N[lang][k]) el.textContent = I18N[lang][k]; });
      // toggle buttons
      document.getElementById("lang-id").classList.toggle("bg-purple-700", lang==="id");
      document.getElementById("lang-en").classList.toggle("bg-purple-700", lang==="en");
    }
    document.getElementById("lang-id").addEventListener("click", ()=>applyLang("id"));
    document.getElementById("lang-en").addEventListener("click", ()=>applyLang("en"));
    applyLang(currentLang);

    // --- Theme ---
    function setBrand(c1,c2){ document.documentElement.style.setProperty('--brand1',c1); document.documentElement.style.setProperty('--brand2',c2); document.getElementById("logo").style.background = `linear-gradient(45deg, ${c1}, ${c2})`; }
    function initTheme(){ const c1 = localStorage.getItem("brawijaya.brand1")||"#7c3aed"; const c2 = localStorage.getItem("brawijaya.brand2")||"#a855f7"; document.getElementById("brand1").value=c1; document.getElementById("brand2").value=c2; setBrand(c1,c2); document.getElementById("brand1").addEventListener("input",(e)=>{ setBrand(e.target.value, document.getElementById("brand2").value); localStorage.setItem("brawijaya.brand1", e.target.value); }); document.getElementById("brand2").addEventListener("input",(e)=>{ setBrand(document.getElementById("brand1").value, e.target.value); localStorage.setItem("brawijaya.brand2", e.target.value); }); }
    initTheme();

    // --- State ---
    let aspect="16:9", resolution="360p", imageEl=null;
    const q = sel => document.querySelector(sel);
    const qa = sel => Array.from(document.querySelectorAll(sel));
    const queue = []; // tasks waiting
    let running = false;

    // --- UI binds ---
    qa(".ar-btn").forEach(b=>b.addEventListener("click", e=>{ qa(".ar-btn").forEach(x=>x.classList.remove("bg-purple-700")); e.currentTarget.classList.add("bg-purple-700"); aspect=e.currentTarget.dataset.ar; }));
    qa(".res-btn").forEach(b=>b.addEventListener("click", e=>{ qa(".res-btn").forEach(x=>x.classList.remove("bg-purple-700")); e.currentTarget.classList.add("bg-purple-700"); resolution=e.currentTarget.dataset.res; }));
    q("#file").addEventListener("change", e=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ imageEl=new Image(); imageEl.src=fr.result; }; fr.readAsDataURL(f); });
    q("#enqueue").addEventListener("click", ()=>{ enqueueJob(); });
    q("#clearHistory").addEventListener("click", ()=>{ localStorage.removeItem("brawijaya.history"); q("#tasks").innerHTML=''; alert(currentLang==="id"?"Riwayat dibersihkan":"History cleared"); });

    function resToWH(res){
      const map = {"360p":360,"720p":720,"1080p":1080}; const h = map[res]||360; let w = Math.round(h*16/9); if(aspect==="1:1") w=h; if(aspect==="9:16") w=Math.round(h*9/16); return {w,h}; }

    // --- Job lifecycle ---
    function enqueueJob(){
      const prompt = q("#prompt").value || "";
      const id = "job_"+Date.now()+"_"+Math.floor(Math.random()*9999);
      const job = { id, prompt, aspect, resolution, imageData: imageEl? imageEl.src:null, status:"queued", progress:0, ts: Date.now() };
      queue.push(job);
      renderQueue();
      processQueue();
    }

    function renderQueue(){
      const wrap = q("#queue"); wrap.innerHTML='';
      queue.forEach(job=>{
        const d = document.createElement("div"); d.className="card p-3";
        d.innerHTML = `<div class="task-row"><div style="flex:1"><div class="muted text-xs">${new Date(job.ts).toLocaleString()}</div><div class="font-semibold">${job.prompt||"(no prompt)"}</div><div class="muted text-xs">${job.aspect} • ${job.resolution}</div></div><div style="width:220px"><div class="progress"><i style="width:${job.progress}%"></i></div><div class="muted text-xs mt-1">${job.status}</div></div></div>`;
        wrap.appendChild(d);
      });
      q("#queueCount").textContent = queue.filter(j=>j.status!=="done").length;
    }

    async function processQueue(){
      if(running) return;
      running = true;
      while(queue.length){
        const job = queue[0];
        if(job.status==="queued" || job.status==="processing"){
          job.status = "processing";
          await runJob(job);
          job.status = "done"; job.progress = 100;
          // move to history (and UI tasks)
          const resItem = await finalizeJob(job);
          saveHistoryItem(resItem);
          addTaskToUI(resItem, false);
        }
        // remove job from queue after done
        queue.shift();
        renderQueue();
      }
      running = false;
    }

    // Simulate/rendering job: produce webm and thumbnail
    async function runJob(job){
      renderQueue();
      const {w,h} = resToWH(job.resolution);
      const canvas = q("#work"); const ctx = canvas.getContext("2d");
      canvas.width = w; canvas.height = h;
      const fps = 30; const duration = 2400; const frames = Math.floor(duration/1000*fps);
      const stream = canvas.captureStream(fps);
      const chunks = []; const rec = new MediaRecorder(stream, {mimeType:"video/webm;codecs=vp8"});
      rec.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
      const done = new Promise(res=>rec.onstop = res);
      rec.start();

      // animate & update progress
      const start = performance.now();
      let lastProgressUpdate = 0;
      function draw(t){
        const p = Math.min(1, (t-start)/duration);
        job.progress = Math.round(p*90); // up to 90% during frames
        if(performance.now() - lastProgressUpdate > 80){ renderQueue(); lastProgressUpdate = performance.now(); }
        // background
        const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,"#15002a"); g.addColorStop(1,"#080012"); ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
        // image or orb
        if(job.imageData){
          const img = new Image(); img.src = job.imageData;
          const scale = 1.05 + 0.08*p; const iw = w*scale, ih = h*scale; const ix = (w-iw)/2 + Math.sin(p*3.14)*w*0.03; const iy = (h-ih)/2 + Math.cos(p*2.1)*h*0.02;
          ctx.globalAlpha = 0.95; ctx.drawImage(img, ix, iy, iw, ih); ctx.globalAlpha = 1;
        }else{
          ctx.fillStyle = "rgba(124,58,237,.35)"; ctx.beginPath(); ctx.arc(w*0.5,h*0.5,(Math.sin(p*3.14)*0.2+0.6)*Math.min(w,h)/3,0,Math.PI*2); ctx.fill();
        }
        // overlay text
        ctx.fillStyle = "rgba(255,255,255,"+(0.5+0.5*Math.sin(p*6))+")";
        ctx.font = Math.floor(h*0.05)+"px sans-serif"; ctx.textAlign="center";
        ctx.fillText(job.prompt||"BRAWIJAYA-AI", w/2, h-30);
        if(p < 1){ requestAnimationFrame(draw); } else { rec.stop(); }
      }
      requestAnimationFrame(draw);
      await done;
      // finalize progress to 95%
      job.progress = 95; renderQueue();
      const blob = new Blob(chunks, {type:"video/webm"});
      // create thumbnail from first frame (draw blob to video)
      const thumbDataUrl = await videoBlobToThumbnail(blob, w, h);
      job.progress = 99; renderQueue();
      // small delay to feel real
      await new Promise(r=>setTimeout(r,250));
      job.progress = 100; renderQueue();
      // return results
      return { blob, thumbDataUrl };
    }

    async function videoBlobToThumbnail(blob, w, h){
      return new Promise((res,rej)=>{
        const vid = document.createElement("video");
        vid.muted = true; vid.playsInline = true; vid.preload = "auto";
        vid.src = URL.createObjectURL(blob);
        vid.currentTime = 0.05;
        vid.addEventListener("loadeddata", ()=>{
          const c = document.createElement("canvas"); c.width = Math.min(320, w); c.height = Math.min(180, h);
          const ctx = c.getContext("2d");
          try{ ctx.drawImage(vid, 0, 0, c.width, c.height); res(c.toDataURL("image/jpeg",0.85)); }
          catch(e){ rej(e); }
        });
        vid.addEventListener("error", e=> rej(e));
      });
    }

    async function finalizeJob(job){
      // runJob already produced blob and thumbDataUrl in job result; but runJob returned them instead of saving to job.
      // For simplicity, re-run small placeholder: in our flow, runJob returned {blob,thumbDataUrl}, but we didn't capture here.
      // To bridge, we'll generate a new small blob by re-rendering same frames quickly.
      // Simpler approach: reconstruct final video from canvas snapshot (already created in runJob, but we need to re-generate a blob).
      // For reliability, we will create a short silent video from canvas frames again synchronously here.
      // NOTE: For demo, reuse canvas capture trick: draw one final frame and capture 1s of that.
      const {w,h} = resToWH(job.resolution);
      const canvas = q("#work"); const ctx = canvas.getContext("2d");
      canvas.width = w; canvas.height = h;
      // draw final frame
      ctx.fillStyle = "#120023"; ctx.fillRect(0,0,w,h);
      if(job.imageData){ const img = new Image(); img.src = job.imageData; ctx.drawImage(img,0,0,w,h);} else { ctx.fillStyle="rgba(124,58,237,.35)"; ctx.beginPath(); ctx.arc(w*0.5,h*0.5,Math.min(w,h)/4,0,Math.PI*2); ctx.fill(); }
      ctx.fillStyle="#fff"; ctx.font = Math.floor(h*0.06)+"px sans-serif"; ctx.textAlign="center"; ctx.fillText(job.prompt||"BRAWIJAYA-AI", w/2, h-30);
      // capture 1s
      const stream = canvas.captureStream(30);
      const chunks=[]; const rec = new MediaRecorder(stream, {mimeType:"video/webm;codecs=vp8"});
      rec.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
      const done = new Promise(r=>rec.onstop=r);
      rec.start();
      await new Promise(r=>setTimeout(r,900));
      rec.stop();
      await done;
      const blob = new Blob(chunks, {type:"video/webm"});
      const thumbDataUrl = canvas.toDataURL("image/jpeg",0.85);
      const item = { url: URL.createObjectURL(blob), dataUrl: await blobToDataURL(blob), thumb: thumbDataUrl, ts: Date.now(), prompt: job.prompt||"", res: job.resolution, ar: job.aspect };
      return item;
    }

    function blobToDataURL(blob){ return new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload = ()=>res(fr.result); fr.onerror = rej; fr.readAsDataURL(blob); }); }

    // --- History persistence ---
    function saveHistoryItem(item){
      try{
        const key="brawijaya.history.v6";
        const arr = JSON.parse(localStorage.getItem(key)||"[]");
        arr.unshift({dataUrl:item.dataUrl, thumb:item.thumb, ts:item.ts, prompt:item.prompt, res:item.res, ar:item.ar});
        const capped = arr.slice(0,12);
        localStorage.setItem(key, JSON.stringify(capped));
      }catch(e){ console.warn("saveHistory fail", e); }
    }
    function loadHistory(){ const key="brawijaya.history.v6"; const arr = JSON.parse(localStorage.getItem(key)||"[]"); arr.forEach(h=>{ addTaskToUI({ url:h.dataUrl, dataUrl:h.dataUrl, thumb:h.thumb, ts:h.ts, prompt:h.prompt, res:h.res, ar:h.ar }, true); }); }

    // --- Tasks UI ---
    function addTaskToUI(item, fromHistory=false){
      const wrap = q("#tasks");
      const d = document.createElement("div"); d.className="card p-3 flex gap-3 items-start";
      d.innerHTML = `
        <img src="${item.thumb}" class="thumb"/>
        <div style="flex:1">
          <div class="font-semibold">${item.prompt||"(no prompt)"}</div>
          <div class="muted text-xs">${new Date(item.ts).toLocaleString()} • ${item.ar} • ${item.res}</div>
          <div class="mt-2 flex gap-2">
            <a href="${item.dataUrl}" download="brawijaya-v6.webm" class="pill">${I18N[currentLang].download}</a>
            <button class="pill copy">${I18N[currentLang].copyLink}</button>
            <button class="pill share">${I18N[currentLang].share}</button>
            <button class="pill upload">${I18N[currentLang].upload}</button>
          </div>
        </div>`;
      wrap.prepend(d);
      // bind buttons
      d.querySelector(".copy").addEventListener("click", ()=>{ navigator.clipboard.writeText(item.dataUrl); alert(currentLang==="id"?"Tautan disalin":"Link copied"); });
      d.querySelector(".share").addEventListener("click", ()=>{
        const shareText = item.prompt?`BRAWIJAYA-AI — \"${item.prompt}\"`:"BRAWIJAYA-AI clip";
        if(navigator.share){ navigator.share({ title:"BRAWIJAYA-AI", text:shareText, url: location.href }).catch(()=>{}); }
        else { prompt(currentLang==="id"?"Salin link ini untuk dibagikan:":"Copy this link to share:", item.dataUrl); }
      });
      d.querySelector(".upload").addEventListener("click", async ()=>{
        // call upload hook
        try{ const res = await uploadToCloud(item); alert((currentLang==="id"?"Upload complete":"Upload complete") + (res && res.url?": "+res.url:"")); } catch(e){ alert((currentLang==="id"?"Upload gagal":"Upload failed")); console.error(e); }
      });
    }

    // --- Upload hook (dummy) ---
    async function uploadToCloud(item){
      // Default: dummy implementation that simulates upload delay.
      // Replace this function with real API upload (Cloudinary, S3, Firebase Storage).
      console.log("uploadToCloud: called", item);
      await new Promise(r=>setTimeout(r,1200));
      // In real implementation, you'd POST item.dataUrl or blob to your server/cloud.
      return { ok:true, url: "https://example.com/your-uploaded/" + Math.floor(Math.random()*999999) };
    }

    // On load – restore history
    window.addEventListener("load", ()=>{ loadHistory(); });

    // Expose queue render for runJob to call
    window.renderQueue = renderQueue;

  </script>
</body>
</html>
